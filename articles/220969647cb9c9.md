---
title: "Pytestã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python","pytest", "playwright"]
published: true
publication_name: yamaden
---

Python ã®ãƒ†ã‚¹ãƒˆã¨ã—ã¦é¦´æŸ“ã¿æ·±ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ŒPytestã€ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/pytest-dev/pytest

Pytest ã¯ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦æº–å‚™ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ä¸€èˆ¬çš„ã«ãƒ†ã‚¹ãƒˆã¯ã€Œãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€ã¨ã€Œçµåˆãƒ†ã‚¹ãƒˆã€ã¨ã„ã†ã‚‚ã®ãŒå­˜åœ¨ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€DB ã® Model ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚„ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ãŒæƒ³å®šã—ãŸçµæœã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã®ãŒãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã¾ã™ã€‚

ã‚ãã¾ã§ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ã—ã¦ã¨ã„ã†ã‚ˆã‚Šã¯ã€æ©Ÿèƒ½ã¨ã—ã¦å•é¡Œãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ†ã‚¹ãƒˆã§ã™ã€‚

ä¸€æ–¹ã€çµåˆãƒ†ã‚¹ãƒˆã¯**ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’çµŒãŸæ§‹æˆè¦ç´ ã‚’çµåˆã—ã€ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ã¾ã¨ã¾ã£ãŸå˜ä½ã§å‹•ä½œã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã“ã¨**ã‚’æŒ‡ã—ã¾ã™ã€‚

ã‚·ã‚¹ãƒ†ãƒ å†…ã®æ©Ÿèƒ½ãŒé€£æºã§ãã¦ã„ã‚‹ã‹æ¤œè¨¼ã§ãã¾ã™ã€‚

ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ãƒ¡ãƒªãƒƒãƒˆã¯ã€å•é¡Œç‚¹ã‚’ç‰¹å®šã—æ˜“ãã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½ã§ã‚ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã®ã«å·¥æ•°ãŒã‹ã‹ã‚Šã¾ã›ã‚“ã€‚

ä¸€æ–¹ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å‹•ä½œã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ãªã„ãŸã‚ã€ãã®ä¿è¨¼ãŒã§ãã‚‹ã®ã¯çµåˆãƒ†ã‚¹ãƒˆã®ãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚

ãã®åˆ†çµåˆãƒ†ã‚¹ãƒˆã¯ã€ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

## Pytestã®å°å…¥

ãã‚Œã§ã¯ã€å®Ÿéš›ã« pytest ã‚’å°å…¥ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

Python ã®ç’°å¢ƒã¯ã§ãã¦ã„ã‚‹æƒ³å®šã§é€²ã‚ã¦ã„ãã¾ã™ã€‚

ã‚‚ã—ã§ãã¦ã„ãªã„äººã¯ã€`venv`ãªã©ã‚’åˆ©ç”¨ã—ãªãŒã‚‰é–‹ç™ºä»®æƒ³ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚

```bash
$ pip install pytest

$ pytest --version
pytest 7.4.0
```

version 7.4 ãŒå…¥ã‚Šã¾ã—ãŸã€‚

pytest ã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åã« test_*.py ã‚„ *_test.py ã¨ã™ã‚‹ã“ã¨ã§è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨èªè­˜ã—ã¦ãã‚Œã¾ã™ã€‚

ã©ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãŠã„ã¦ã‚‚ä¸Šè¨˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èªè­˜ã—ã¾ã™ãŒã€ã§ãã‚Œã°ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ãŸã„ã®ã§ã€tests/ã‚’ä½œã‚‹ã¨è‰¯ã„ã§ã™ã€‚

test_basic.py ã¨ã—ã¦ä¸‹è¨˜ã‚’ä½œã‚Šã¾ã™ã€‚

```python
def inc(x):
    return x + 1

def test_answer():
    assert inc(3) == 5
```

ä¸‹è¨˜ã‚’å®Ÿè¡Œã—ã€å¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```bash
$ pytest
==================================== test session starts ====================================
platform darwin -- Python 3.9.4, pytest-7.4.0, pluggy-1.2.0
rootdir: /streamlit_pytest
collected 1 item

tests/test_basic.py F                                                                                                                                                          [100%]

==================================== FAILURES ====================================
____________________________________________________________________________________ test_answer _____________________________________________________________________________________

    def test_answer():
>       assert inc(3) == 5
E       assert 4 == 5
E        +  where 4 = inc(3)

tests/test_basic.py:6: AssertionError
==================================== short test summary info ====================================
FAILED tests/test_basic.py::test_answer - assert 4 == 5
==================================== 1 failed in 0.04s ====================================
```

ä¾‹å¤–å‡¦ç†ãŒèµ·ãã‚‹ã“ã¨ã‚‚ãƒã‚§ãƒƒã‚¯å¯èƒ½ã§ã™ã€‚

```bash
import pytest

def f():
    raise SystemExit(1)

def test_mytest():
    with pytest.raises(SystemExit):
        f()
```

### ãƒ†ã‚¹ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–

pytest ã§ã¯ã€è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã‚’å«ã‚€ã‚¯ãƒ©ã‚¹ã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™ã€‚

```python
class TestClass:
    def test_one(self):
        x = "this"
        assert "h" in x

    def test_two(self):
        x = "hello"
        assert hasattr(x, "check")
```

### ãƒ‡ãƒãƒƒã‚°

ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ `print` ã‚’æ›¸ã„ã¦ã‚‚å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```bash
$ pytest -s
```

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãŸãã•ã‚“ã‚ã‚Šã¾ã™ãŒã€ä¸‹è¨˜ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ç¢ºèªå¯èƒ½ã§ã™ã€‚

```bash
$ pytest --help
```

## ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

pytest ã«å°å…¥ã™ã‚‹ã¨ä¾¿åˆ©ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### pytest-pycodestyle

`--pep8`PEP8 æº–æ‹ ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ã€`pytest-pycodestyle`ãŒã‚ã‚Šã¾ã™ã€‚

å…ƒã€…ã¯ã€`pytest-pep8`ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã—ãŸã€‚

https://github.com/henry0312/pytest-pycodestyle

```bash
$ pip install pytest-pycodestyle
$ pytest --pycodestyle ...
```

è¨­å®šã‚’ã“ã¡ã‚‰ã§å¤‰æ›´å¯èƒ½ã§ã™ã€‚

```bash
[pycodestyle]
max-line-length = 127

[tool:pytest]
# ã“ã‚Œã§pytestã ã‘ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
addopts = --pycodestyle
```

### pyflakes

pyflakes ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

https://pypi.org/project/pytest-flakes/

https://github.com/asmeurer/pytest-flakes

```bash
$ pip install pytest-flakes

$ pytest --flakes
==================================== test session starts ====================================
platform darwin -- Python 3.9.4, pytest-7.4.0, pluggy-1.2.0
rootdir: /Users/naoki/Documents/matsuzaki-app/streamlit_pytest
plugins: flakes-4.0.5
collected 5 items

main.py s                                                                                                                                                                      [ 20%]
pages/page1.py s                                                                                                                                                               [ 40%]
pages/page2.py s                                                                                                                                                               [ 60%]
tests/test_basic.py ..                                                                                                                                                         [100%]

==================================== 2 passed, 3 skipped in 0.01s ====================================
```

## Pytestã®ç´°ã‹ãªæ©Ÿèƒ½

ã“ã“ã‹ã‚‰ã¯ä¸€æ­©é€²ã‚“ã  Pytest ã®æ©Ÿèƒ½ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### Pytestã® fixturesã«ã¤ã„ã¦

`@pytest.fixture`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãã‚Œãã‚Œã®ãƒ†ã‚¹ãƒˆã§å‰å‡¦ç†ã¨å¾Œå‡¦ç†ãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```python
import pytest

class TestFixtures:
    @pytest.fixture()
    def sample(self):
        print("å‰å‡¦ç†")
        yield
        print("å¾Œå‡¦ç†")

    def test_hoge(self, sample):
        print("æœ¬å‡¦ç†")
        assert 1 == 1
```

ã“ã†ã™ã‚‹ã“ã¨ã§ã€`test_hoge`é–¢æ•°ãŒå‘¼ã°ã‚ŒãŸéš›ã€å¼•æ•°ã«`sample`ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€`sample`é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

`sample`é–¢æ•°ã«ã¯ã€`yield`ãŒæ›¸ã‹ã‚Œã¦ãŠã‚Šã€ã“ã“ã§`test_hoge`ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã„ã‚ã‚†ã‚‹ã€fixtures ã«ã‚ˆã£ã¦å‰å‡¦ç†ã¨å¾Œå‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

fixtures ã«ã¯ã€scope ãŒå®šç¾©ã§ãã¾ã™ã€‚

| scopeæŒ‡å®š | è©³ç´° |
| --- | --- |
| scope=â€™functionâ€™ | ãƒ†ã‚¹ãƒˆé–¢æ•°ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) |
| scope=â€™classâ€™ | ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ |
| scope=â€™moduleâ€™ | ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«(ãƒ•ã‚¡ã‚¤ãƒ«)ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ |
| scope=â€™packageâ€™ | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ |
| scope=â€™ã‚»ãƒƒã‚·ãƒ§ãƒ³â€™ | ã‚»ãƒƒã‚·ãƒ§ãƒ³(pytestã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½)ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œã€‚ |

```python
import pytest

@pytest.fixture(scope="function")
def fixture_function():
    """
    ãƒ†ã‚¹ãƒˆé–¢æ•°ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ
    """
    print("å‰å‡¦ç†ï¼š function")
    yield
    print("å¾Œå‡¦ç†ï¼š function")

@pytest.fixture(scope="class")
def fixture_class():
    """
    ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ
    """
    print("å‰å‡¦ç†ï¼š class")
    yield
    print("å¾Œå‡¦ç†ï¼š class")

@pytest.fixture(scope="module")
def fixture_module():
    """
    ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«(ãƒ•ã‚¡ã‚¤ãƒ«)ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ
    """
    print("å‰å‡¦ç†ï¼š module")
    yield
    print("å¾Œå‡¦ç†ï¼š module")

@pytest.fixture(scope="session")
def fixture_session():
    """
    ã‚»ãƒƒã‚·ãƒ§ãƒ³(pytestã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½)ã”ã¨ã«ã€ä¸€å›å®Ÿè¡Œ
    """
    print("å‰å‡¦ç†ï¼š session")
    yield
    print("å¾Œå‡¦ç†ï¼š session")

class TestFixtureScope_2:
    def test_1(self, fixture_function, fixture_class, fixture_module, fixture_session):
        pass

    def test_2(self, fixture_function, fixture_class, fixture_module, fixture_session):
        pass

class TestFixtureScope_1:
    def test_1(self, fixture_function, fixture_class, fixture_module, fixture_session):
        pass

    def test_2(self, fixture_function, fixture_class, fixture_module, fixture_session):
        pass
```

```bash
$ pytest

tests/unit/test_scope.py ..å‰å‡¦ç†ï¼š session
å‰å‡¦ç†ï¼š module
å‰å‡¦ç†ï¼š class
å‰å‡¦ç†ï¼š function
.å¾Œå‡¦ç†ï¼š function
å‰å‡¦ç†ï¼š function
.å¾Œå‡¦ç†ï¼š function
å¾Œå‡¦ç†ï¼š class
å‰å‡¦ç†ï¼š class
å‰å‡¦ç†ï¼š function
.å¾Œå‡¦ç†ï¼š function
å‰å‡¦ç†ï¼š function
.å¾Œå‡¦ç†ï¼š function
å¾Œå‡¦ç†ï¼š class
å¾Œå‡¦ç†ï¼š module
å¾Œå‡¦ç†ï¼š session
```

ã“ã®ã‚ˆã†ã«ã€scope ã«ã‚ˆã£ã¦å®Ÿè¡Œå˜ä½ã‚’å¤‰ãˆã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### fixturesã‚’å…±æœ‰

è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ fixture ã‚’å…±æœ‰ã—ãŸã„æ™‚ã¯ã€`conftest.py` ã«å®šç¾©ã™ã‚Œã°ã€ç°¡å˜ã«å…±æœ‰ãŒã§ãã¾ã™ã€‚

`conftest.py`ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```python
import pytest

@pytest.fixture(scope="session")
def conf():
    print("conftestï¼šå‰å‡¦ç†")
    yield
    print("conftestï¼šå¾Œå‡¦ç†")
```

ã‚ã¨ã¯åˆ©ç”¨å´ã§ `conf` ã‚’å¼•æ•°ã«æ¸¡ã—ã¦ã‚ã’ã‚‹ã ã‘ã§ã™ã€‚

### Pytestã® Autouse fixturesã«ã¤ã„ã¦

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã§ä¾å­˜ã™ã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ (ã‚ã‚‹ã„ã¯è¤‡æ•°) ã‚’ç”¨æ„ã—ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

`autouse`fixtures ã¯ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒè‡ªå‹•çš„ã«ãã‚Œã‚‰ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ä¾¿åˆ©ãªæ–¹æ³•ã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€å†—é•·ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å¤šãã‚’ã‚«ãƒƒãƒˆã§ãã¾ã™ã€‚

fixtures ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã« autouse=True ã‚’æ¸¡ã™ã“ã¨ã§ã€ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’è‡ªå‹•ç”Ÿæˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã«ã§ãã¾ã™ã€‚

```python
import pytest

@pytest.fixture
def first_entry():
    return "a"

@pytest.fixture
def order(first_entry):
    return []

@pytest.fixture(autouse=True)
def append_first(order, first_entry):
    return order.append(first_entry)

def test_string_only(order, first_entry):
    assert order == [first_entry]

def test_string_and_int(order, first_entry):
    order.append(2)
    assert order == [first_entry, 2]
```

ä¸Šè¨˜ã®ã‚ˆã†ã« `autouse=True` ã‚’æ›¸ãã“ã¨ã§ã€å¼•æ•°ã«ãã®é–¢æ•°ã‚’æ¸¡ã•ãªãã¦ã‚‚ã€ãƒ†ã‚¹ãƒˆã§å¿…ãšå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¾‹ãˆã°ã€`test_string_only`é–¢æ•°ã§ã€ã¾ãšåˆã‚ã« `append_first`é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

ãã®`append_first`ã§ã¯ã€order ã« â€œaâ€ã‚’å…¥ã‚Œã‚‹å‡¦ç†ãŒã•ã‚Œã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€  `order == [first_entry]`ãŒ true ã¨ãªã‚‹ã®ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã¨ã„ã†æ¦‚å¿µã§ã€`@pytest.mark.parametrize` ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯èª¬æ˜ã‚’çœãã¾ã™ã€‚

https://docs.pytest.org/en/7.3.x/how-to/parametrize.html#pytest-mark-parametrize-parametrizing-test-functions


## E2Eãƒ†ã‚¹ãƒˆã¨ã¯

End to Endï¼šã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ç•¥ã§ã™ã€‚

ã‚ã‚‰ã‚†ã‚‹æ§‹æˆè¦ç´ ã‚’çµ„ã¿è¾¼ã‚“ã çŠ¶æ…‹ã§ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å“è³ªã‚’ä¿è¨¼ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚

UI æ“ä½œã‚’ã¨ã‚‚ãªã†ã“ã¨ã‹ã‚‰ã€ŒUI ãƒ†ã‚¹ãƒˆã€ã¨å‘¼ã°ã‚Œã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®é€šä¿¡ãªã©ã‚‚ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã«å«ã¾ã‚Œã‚‹ãŸã‚ã€ã‚ˆã‚Šä¸Šä½ã®æ¦‚å¿µã¨ã„ãˆã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã®ä¸­ã§ã‚‚å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹•ãã«è¿‘ã„ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã¨ãªã‚‹ãŸã‚ã€å“è³ªã‚’æ‹…ä¿ã§ãã‚‹ãƒ†ã‚¹ãƒˆã¨ã‚‚è¨€ãˆã¾ã™ã€‚

èª²é¡Œã¨ã—ã¦ã¯ã€ã‚„ã¯ã‚Šå°å…¥ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ã“ã¨ã§ã™ã€‚

ã—ã‹ã—ã€ã“ã® playwright ã¯ Pytest ã§å®Ÿæ–½ã§ãã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ãŸã‚ã€ãã‚Œã‚’ä½¿ãˆã°ç°¡å˜ã«å°å…¥ã§ããã†ã§ã™ã€‚

## Pytestã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã‚’å°å…¥

ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã§ã€ã€Œplaywrightã€ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

https://playwright.dev/python/

ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶é·ç§»ç­‰ã® E2E ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

Playwright ã¯ã€Chromiumã€WebKitã€Firefox ãªã©ã®æœ€æ–°ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ã™ã¹ã¦ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

Windowsã€Linuxã€macOS ä¸Šã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ CI ä¸Šã§ã€ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒã‚¤ãƒ†ã‚£ãƒ– ãƒ¢ãƒã‚¤ãƒ« ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ãŸãƒ˜ãƒƒãƒ‰ã§ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

## Pytestã¨Playwrightã®åˆ©ç”¨

Playwright ã§ã¯ã€å…¬å¼ã®[Playwright Pytest ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’](https://playwright.dev/python/docs/test-runners)ä½¿ç”¨ã—ã¦ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆ†é›¢ã‚’æä¾›ã—ã€ã™ãã«è¤‡æ•°ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼æ§‹æˆã§å®Ÿè¡Œã§ãã¾ã™ã€‚

Pytest ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ Playwright ã®åŒæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æº–å‚™

```bash
$ pip install pytest-playwright
```

å¿…è¦ãªãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ playwright install
```

ã‚ã¨ã¯ã€pytest ã®ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‘ã° OK ã§ã™ã€‚

ä»Šå›ã¯ tests/browser/test_basic.py ã¨è¨­å®šã—ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã‚’æ²è¼‰ã—ã¾ã™ã€‚

```python
import re
from playwright.sync_api import Page, expect

def test_homepage_has_Playwright_in_title_and_get_started_link_linking_to_the_intro_page(page: Page):
    page.goto("https://playwright.dev/")

    # Expect a title "to contain" a substring.
    expect(page).to_have_title(re.compile("Playwright"))

    # create a locator
    get_started = page.get_by_role("link", name="Get started")

    # Expect an attribute "to be strictly equal" to the value.
    expect(get_started).to_have_attribute("href", "/docs/intro")

    # Click the get started link.
    get_started.click()

    # Expects the URL to contain intro.
    expect(page).to_have_url(re.compile(".*intro"))
```

`to_have_title` ã‚„ `to_have_url`ã¯ãƒšãƒ¼ã‚¸ã«å¯¾ã™ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ãªã£ã¦ã„ã¾ã™ã€‚

- æŒ‡å®šã—ãŸã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒã£ã¦ã„ã‚‹ã‹
- æŒ‡å®šã—ãŸ URL ã«ãªã£ã¦ã„ã‚‹ã‹

ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

ä¸€æ–¹ã€`to_have_attribute`ã‚„ `to_be_checked`ã¯ã€ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã«å¯¾ã™ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ãªã£ã¦ã„ã¾ã™ã€‚

- è¦ç´ ã«æŒ‡å®šã—ãŸå±æ€§ã‚’æŒã¡åˆã‚ã›ã¦ã„ã‚‹ã‹
- è¦ç´ (ã“ã“ã§ã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹)ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸçŠ¶æ…‹ã§ã‚ã‚‹ã‹

ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

ã“ã®è¾ºã‚Šã®ä»–ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã—ã¦ã¯ã€ä¸‹è¨˜ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒãã ã•ã„ã€‚

https://playwright.dev/python/docs/test-assertions

### ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã®æŒ‡å®š

ã¾ãŸã€ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ã©ã†ã‚„ã£ã¦æ¤œç´¢ã™ã‚Œã°è‰¯ã„ã‹ã«ã¤ã„ã¦ã¯ã€ä¸‹è¨˜ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

https://playwright.dev/python/docs/locators

`get_by_role` ã§å–å¾—ã™ã‚‹ãŸã‚ã® role ã®æŒ‡å®šã¯æ§˜ã€…ã‚ã‚Šã¾ã™ã€‚

ãƒ­ãƒ¼ãƒ« ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã«ã¯ã€ãƒœã‚¿ãƒ³ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€è¦‹å‡ºã—ã€ãƒªãƒ³ã‚¯ã€ãƒªã‚¹ãƒˆã€ãƒ†ãƒ¼ãƒ–ãƒ«ãªã©ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€Â ARIA ãƒ­ãƒ¼ãƒ«ã€ARIA å±æ€§ã€ãŠã‚ˆã³ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªåå‰ã® W3C ä»•æ§˜ã«å¾“ã£ã¦ã„ã¾ã™ã€‚

https://www.w3.org/TR/html-aria/#docconformance

`css` ã§ã‚‚æŒ‡å®šã§ãã¾ã™ã€‚

```html
<button style='display: none'>Invisible</button>
<button>Visible</button>
```

```python
page.locator("button").locator("visible=true").click()
```

expect ã§ã¯ã€ç¬¬äºŒå¼•æ•°ã«ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```python
expect(page.get_by_text("Name"), "should be logged in").to_be_visible()

def test_foobar(page: Page) -> None:
>       expect(page.get_by_text("Name"), "should be logged in").to_be_visible()
E       AssertionError: should be logged in
E       Actual value: None
E       Call log:
E       LocatorAssertions.to_be_visible with timeout 5000ms
E       waiting for get_by_text("Name")
E       waiting for get_by_text("Name")

tests/test_foobar.py:22: AssertionError
```

### ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

```html
<ul>
  <li>
    <h3>Product 1</h3>
    <button>Add to cart</button>
  </li>
  <li>
    <h3>Product 2</h3>
    <button>Add to cart</button>
  </li>
</ul>
```

ä¾‹ãˆã°ä¸Šè¨˜ã®ã‚ˆã†ã« button ãŒ 2 ã¤ã‚ã‚‹ã¨ã€get_by_role(â€buttonâ€)ã§æ¢ã™ã¨ 2 ã¤ãƒ’ãƒƒãƒˆã—ã¾ã™ã€‚

ãã®å ´åˆã€ä¸‹è¨˜ã®ã‚ˆã†ã«`filter`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ 1 ã¤ã«çµã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
page.get_by_role("listitem").filter(has_text="Product 2").get_by_role(
    "button", name="Add to cart"
).click()
```

ã“ã‚Œã¯ã€ã¾ãš listitem(`<li>`ã‚¿ã‚°)ã‚’ filter ã§ â€œProduct 2â€ã‚’æŒã£ã¦ã„ã‚‹ li ã‚¿ã‚°ã«çµã‚Šã€ãã®ä¸­ã§ã€button ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚

ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç‹­ã‚ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚

filter ã«ï¼”æ–¹æ³•ä½¿ãˆã¾ã™ã€‚

- has_text
- has_not_text
- has
- has_not


has ã‚„ has_not ã¯ã€ä¸­ã®è¦ç´ ã§æ¤œç´¢ã™ã‚‹ã¨ãã«ã¤ã‹ã„ã¾ã™ã€‚

```python
page.get_by_role("listitem").filter(
    has=page.get_by_role("heading", name="Product 2")
).get_by_role("button", name="Add to cart").click()
```

ã“ã†ã™ã‚‹ã“ã¨ã§ã€`<li>` ã‚¿ã‚°ã®ä¸­ã§ã€Product 2 ã® heading ã® role ã‚’æŒã¤ã‚¿ã‚°ã«çµã‚Šè¾¼ã‚ã¾ã™ã€‚

### ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’åˆ©ç”¨ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ

https://playwright.dev/python/docs/input

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

pytest åŒæ§˜ã«å®Ÿè¡Œã§ãã¾ã™ã€‚

(-s ã‚’ã¤ã‘ã¦ãƒ‡ãƒãƒƒã‚°ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™)

```bash
$ pytest -s
```

ä¸‹è¨˜ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€Playwright Inspector ãŒèµ·å‹•ã—ã€ã‚¹ãƒ†ãƒƒãƒ—æ¯ã«å®Ÿè¡Œã§ãã¾ã™ã€‚

```bash
$ PWDEBUG=1 pytest -s
```

ã¾ãŸã€pytest ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ãªã®ã§ã€ä¸‹è¨˜ã§ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ãŒã§ãã¾ã™ã€‚

```bash
$ pytest --headed
```

ç‰¹å®šã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æŒ‡å®šã§ãã¾ã™ã€‚

```bash
$ pytest --browser webkit --browser firefox
```

å¤±æ•—æ™‚ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚Šã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãå ´æ‰€ã‚’æŒ‡å®šã‚‚å¯èƒ½ã§ã™ã€‚

```bash
$ pytest --screenshot only-on-failure --output ./test-results/
```

ãƒ†ã‚¹ãƒˆã‚’ä¸¦è¡Œã—ã¦å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã§ã™ã€ãŸã ã“ã‚Œã¯ã€`pytest-xdist`ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
$ pytest --numprocesses auto
```

ä¸¦è¡Œå‡¦ç†ã«ã¤ã„ã¦ã¯ã€è©³ã—ãã¯èª¬æ˜ã—ã¾ã›ã‚“ã€‚

ä¸‹è¨˜ã‚’å‚ç…§ãã ã•ã„ã€‚

- https://playwright.dev/python/docs/test-runners#parallelism-running-multiple-tests-at-once
- https://qiita.com/yaboxi_/items/0cdc2818bf8acf6f00de
- https://rcmdnk.com/blog/2023/03/13/computer-python/

### ãƒ†ã‚¹ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®åˆ©ç”¨

playwright ã§ã¯ã€å®Ÿéš›ã®æ“ä½œã‚’è¨˜éŒ²ã—ã€ãã‚Œã‚’ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ codegen ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

ãã®å¾Œã«ãƒ†ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ Web ã‚µã‚¤ãƒˆã® URL ã‚’æŒ‡å®šã—ã¾ã™ã€‚

URL ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€ã„ã¤ã§ã‚‚ URL ã‚’æŒ‡å®šã›ãšã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ä»£ã‚ã‚Šã«ãƒ–ãƒ©ã‚¦ã‚¶ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ URL ã‚’ç›´æ¥è¿½åŠ ã§ãã¾ã™ã€‚

```bash
$ playwright codegen demo.playwright.dev/todomvc
```

### ãƒ™ãƒ¼ã‚¹URLã®è¨­å®š

URL ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ä¸‹è¨˜ã®ã‚ˆã†ã«å¯èƒ½ã§ã™ã€‚

```bash
pytest --base-url http://localhost:8080
```

```python
def test_visit_example(page):
    page.goto("/admin")
    # -> Will result in http://localhost:8080/admin
```

## ã¾ã¨ã‚

pytest ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã® playwright ã‚’ã†ã¾ãä½¿ã„ã“ãªã™ã‚ˆã†ã«ãªã‚‹ãŸã‚ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚Šãã†ã§ã™ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã‚‚ pytest ã§ã§ãã‚‹ã®ã¯ã¨ã¦ã‚‚ä¾¿åˆ©ã ã¨æ„Ÿã˜ã¾ã™ã€‚

ã‚‚ã†å°‘ã—çŸ¥è¦‹ã‚’å¢—ã‚„ã—ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ã«ã‚ˆã‚‹å“è³ªæ‹…ä¿ã«åŠªåŠ›ã—ãŸã„ã§ã™ã€‚
