---
title: "Dockerã§Volumeç®¡ç†ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ãŸæ™‚ã®Tips"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Laravel", "Docker", "MySQL"]
published: true
---

# ç†è§£ã—ãªã„ã¨ã„ã‘ãªã„ã“ã¨

Docker ã§ã¯ã€volume ã¨ã„ã†ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒŠã¯èµ·å‹•ã—ã€åœæ­¢ã™ã‚‹ã¨æ¯å›ç ´æ£„ã—ã¦ã—ã¾ã†ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãŠãã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ä¿å­˜ã™ã‚‹ãªã‚‰ã€volume ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é‹ç”¨ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚

volume ã«ã¤ã„ã¦ã¯ã“ã“ã§èª¬æ˜ã¯çœç•¥ã—ã¾ã™ãŒã€ä¸‹è¨˜è¨˜äº‹ã¯ã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

https://qiita.com/gounx2/items/23b0dc8b8b95cc629f32

## ä¸€åº¦ä½œæˆã—ãŸ MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰åˆ¥ã®åå‰ã«å¤‰æ›´ã™ã‚‹å ´åˆã®æ³¨æ„

`docker-compose.yml`ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ã¯ã†ã¾ãã„ã‹ãªã„ã€‚

ãã®ç†ç”±ã¯ MySQL ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ Docker ã®`volume`ã«ä¿å­˜ã—ã¦ã„ã‚‹ã‹ã‚‰ã€‚

`docker-compose.yml`ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã§ä¸‹è¨˜ã®é€šã‚Šè¨˜è¼‰ã—ã¦ã„ã‚‹ã€‚

```yaml
volumes:
  - db-volume:/var/lib/mysql
```

ãã®ãŸã‚ã€docker ã®`volume`ã‚‚å‰Šé™¤ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ãŸã‚ã€volume å‰Šé™¤ã‚‚æ‰‹é †ã¨ã—ã¦å¿…è¦ã«ãªã‚‹ã€‚

## ä½œæ¥­å†…å®¹

1. docker-compose.yml ã®ä¿®æ­£
2. Laravel ã®.env ã®ä¿®æ­£
3. docker volume ã®å‰Šé™¤
4. docker ã®å†ãƒ“ãƒ«ãƒ‰
5. MySQL èªè¨¼æ–¹æ³•ã®å¤‰æ›´(MySQL8 ã®ã¿)
6. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª

## docker-compose.yml ã®ä¿®æ­£

ä¸‹è¨˜ã®é€šã‚Šè¨˜è¼‰ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´

### **å¤‰æ›´å‰**

```yaml
#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠ
mysql:
  image: mysql:8.0
  container_name: mysql
  ports:
    - "4306:3306"
  environment:
    MYSQL_DATABASE: test
    MYSQL_USER: docker
    MYSQL_PASSWORD: docker
    MYSQL_ROOT_PASSWORD: root
    TZ: "Asia/Tokyo"
  volumes:
    - db-volume:/var/lib/mysql
```

`MYSQL_DATABASE`ã€`MYSQL_USER`ã€`MYSQL_PASSWORD`ã‚’ä¿®æ­£

### **å¤‰æ›´å¾Œ**

```yaml
#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠ
mysql:
  image: mysql:8.0
  container_name: mysql
  ports:
    - "4306:3306"
  environment:
    MYSQL_DATABASE: test-2
    MYSQL_USER: docker-2
    MYSQL_PASSWORD: docker-2
    MYSQL_ROOT_PASSWORD: root
    TZ: "Asia/Tokyo"
  volumes:
    - db-volume:/var/lib/mysql
```

## Laravel ã®.env ä¿®æ­£

ä¸‹è¨˜ã®é€šã‚Šè¨˜è¼‰ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´

### **å¤‰æ›´å‰**

```yaml
DB_CONNECTION=mysql
DB_HOST=mysql
DB_PORT=3306
DB_DATABASE=test
DB_USERNAME=docker
DB_PASSWORD=docker
```

`MYSQL_DATABASE`ã€`MYSQL_USER`ã€`MYSQL_PASSWORD`ã‚’ä¿®æ­£

### **å¤‰æ›´å¾Œ**

```yaml
DB_CONNECTION=mysql
DB_HOST=mysql
DB_PORT=3306
DB_DATABASE=test-2
DB_USERNAME=docker-2
DB_PASSWORD=docker-2
```

## docker volume å‰Šé™¤

### volume ç¢ºèª

ãƒ›ã‚¹ãƒˆå´ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«(or ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)ã«ã¦ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ

```yaml
docker volume ls
```

ä¸‹è¨˜`volume`ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

```yaml
local     ****_db-volume
```

### volume å‰Šé™¤

**â€»docker ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå‹•ã„ã¦ã„ã‚‹æ™‚ã«ã‚„ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã™ã€‚å¿…ãšã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¦ã‹ã‚‰ã‚„ã‚‹ã“ã¨ï¼**

```yaml
Error response from daemon: remove ****_db-volume: volume is in use - [48abed9a0abfe9b06a5bba351f0ea862d16ead41d40e48a50981a0dec5c72a29]
```

ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ã‚’ç¢ºèªã—ãŸã‚‰ä¸‹è¨˜å®Ÿè¡Œ

```yaml
$ docker volume rm ****_db-volume

// å‰Šé™¤å¾ŒvolumeãŒãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹
$ docker volume ls
```

## docker ã®å†ãƒ“ãƒ«ãƒ‰

`docker-compose.yml`ãŒå¤‰æ›´ã•ã‚Œã€`volume`ã‚‚å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å†åº¦ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã€‚

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ“ãƒ«ãƒ‰ã¨ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‚’åŒæ™‚ã«å¯èƒ½ã€‚

```yaml
docker-compose up -d -build
```

## MySQL èªè¨¼æ–¹æ³•ã®å¤‰æ›´

MySQL8 ã®ã¿å®Ÿè¡Œ

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

Laravel ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€Laravel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã£ã¦ã„ã‚‹ php ã‚³ãƒ³ãƒ†ãƒŠã¸ãƒ­ã‚°ã‚¤ãƒ³

```yaml
$ docker-compose exec php bash
```

**ä»¥ä¸‹ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ä½œæ¥­ã¨ãªã‚Šã¾ã™**

```
/var/www/html# php artisan migrate
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã€ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã§ãã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã€‚

MySQL ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Šã€root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã€‚

ãã®å¾Œã€ä¿®æ­£ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(`test-2`)ã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚

```
matsunoMBP:crm-backend naoki$ docker-compose exec mysql bash
root@0573a3c19569:/# mysql -u root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 10
Server version: 8.0.23 MySQL Community Server - GPL

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> use test-2
Database changed

mysql>
mysql> show tables;
+-----------------------+
| Tables_in_crm_test_db |
+-----------------------+
| course                |
| migrations            |
| term                  |
| user                  |
+-----------------------+
4 rows in set (0.01 sec)
```

## ç‚ºã«ãªã‚‹æ–‡çŒ®

[ã€Dockerã€‘docker-compose.yml ã®å¤‰æ›´ãŒ DB ã«åæ˜ ã•ã‚Œãªã‹ã£ãŸè©± - Qiita](https://qiita.com/rebi/items/2bd8924ec89c4c779a50)

[Docker volume ã®å‰Šé™¤ - Qiita](https://qiita.com/Ikumi/items/b319a12d7e2c9f7b904d)
