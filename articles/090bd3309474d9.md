---
title: "Laravelã«é™çš„è§£æãƒ„ãƒ¼ãƒ«ã®Larastanã‚’å°å…¥ã—ã€å³ã—ããƒã‚§ãƒƒã‚¯ã™ã‚‹"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Laravel", "PHP", "PHPStan"]
published: true
---

php ã§æœ‰åãª PHPStan ã¨ã„ã†é™çš„è§£æãƒ„ãƒ¼ãƒ«ãŒã‚ã‚‹ã®ã§ã™ãŒã€ãã® Laravel ç‰ˆã¨ã—ã¦ Larastan ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Laravel ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

ä»Šå›ã¯ãã® Larastan ã®å°å…¥ã¨ã©ã†è¨€ã£ãŸè§£æãŒå¯èƒ½ã«ãªã‚‹ã®ã‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Larastan ã¯ composer ã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚php ã ã¨ PHPStan ã§ã™ãŒã€ã“ã® Larastan ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ã€ä¸€ç·’ã« PHPStan ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã‚Œã¾ã™ã€‚

```
composer --dev require nunomaduro/larastan
```

vender ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸã®ã§ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
./vendor/bin/phpstan analyse -V
PHPStan - PHP Static Analysis Tool 1.5.6
```

ä¸Šè¨˜ã®é€šã‚Šã€ãƒ™ãƒ¼ã‚¹ã¯ PHPStan ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

Larastan ã‚’å®Ÿè¡Œã™ã‚‹éš›ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€ã€Œphpstan.neonã€ã¾ãŸã¯ã€Œphpstan.neon.distã€ã§ä½œæˆã—ã¾ã™ã€‚

```
includes:
    - ./vendor/nunomaduro/larastan/extension.neon

parameters:

    paths:
        - app

    # The level 9 is the highest level
    level: 5

    ignoreErrors:
        - '#Unsafe usage of new static#'

    excludePaths:
        - ./*/*/FileToBeExcluded.php

    checkMissingIterableValueType: false
```

## è§£æå®Ÿè¡Œ

å®Ÿéš›ã«è§£æã—ã¾ã™ã€‚

```
./vendor/bin/phpstan analyse
```

å®Ÿè¡Œå¾Œã€ä¸‹è¨˜ã®ã‚ˆã†ã«ãƒ¡ãƒ¢ãƒªä¸è¶³ã®ã‚¨ãƒ©ãƒ¼èµ·ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```
Child process error (exit code 255): [2022-05-02 00:50:29] local.ERROR: Allowed memory size of 134217728 bytes exhausted (tried to allocate 20480 bytes) {"exception":"[object] (Symfony\\Component\\ErrorHandler\\Error\\FatalError(code: 0): Allowed memory size of 134217728
     bytes exhausted (tried to allocate 20480 bytes) at phar:///Users/naokim/Documents/matsuzaki_app/nextporn/vendor/phpstan/phpstan/phpstan.phar/vendor/phpstan/phpdoc-parser/src/Lexer/Lexer.php:69)
```

ãã®å ´åˆã€ãƒ¡ãƒ¢ãƒªä¸Šé™ã‚’ä¸Šã’ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã¨è‰¯ã„ã§ã™ã€‚

```
./vendor/bin/phpstan analyse --memory-limit=2G
```

å®Ÿè¡Œå¾Œã€ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

## é©ç”¨ãƒ«ãƒ¼ãƒ«ã®è§£èª¬

### NoModelMake

### NoUnnecessaryCollectionCall

```
 ------ ---------------------------------------------------------------------------------
  Line   app/Consts/SitemapUrl.php
 ------ ---------------------------------------------------------------------------------
  51     Called 'count' on Laravel collection, but could have been retrieved as a query.
 ------ ---------------------------------------------------------------------------------
```

ä¸Šè¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã¯ã€ç„¡é§„ãªã‚¯ã‚¨ãƒªã®æ¤œçŸ¥ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚

ä¾‹ãˆã°ã€ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

```
Category::all()->count()
```

ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ä»¶æ•°ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€count()ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€collection ã¨ã—ã¦å–å¾—ã—ãŸå¾Œã«ä»¶æ•°ã‚’å–å¾—ã—ãªãã¦ã‚‚è‰¯ã„ã®ã§ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ä¿®æ­£ã§ãã¾ã™ã€‚

```
Category::count()
```

ã“ã®ã‚ˆã†ã«ç„¡é§„ãªã‚¯ã‚¨ãƒªã®ç®‡æ‰€ã‚‚æŒ‡æ‘˜ã•ã‚Œã¾ã™ã€‚

### CheckDispatchArgumentTypesCompatibleWithClassConstructorRule

```
 ------ --------------------------------------------------------------
  Line   app/Mail/ContactPage.php
 ------ --------------------------------------------------------------
  22     Access to an undefined property App\Mail\ContactPage::$message.
 ------ --------------------------------------------------------------
```

ã‚¸ãƒ§ãƒ–ã®ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå¼•æ•°ã®å‹ãŒã‚¸ãƒ§ãƒ–ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã¨äº’æ›æ€§ãŒã‚ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

ã‚¸ãƒ§ãƒ–ã«é™ã‚‰ãšã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿é–¢æ•°ã‚’å‘¼ã‚“ã§ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã£ãŸå ´åˆã€$message ã®å®šç¾©ã‚’ã—ã¦ã„ãªã„ã¨ undefined ã®ã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã—ã¾ã™ã€‚

```
/**
  * Create a new message instance.
  *
  * @return void
  */
public function __construct($message)
{
    $this->message = $message;
}
```

ä¸‹è¨˜ã®é€šã‚Šã€$message å®šç¾©ã‚’ã—ã¾ã™ã€‚

```
/**
  * ãŠå•ã„åˆã‚ã›å†…å®¹
  *
  * @var string
  */
protected $message;

/**
  * Create a new message instance.
  *
  * @return void
  */
public function __construct($message)
{
    $this->message = $message;
}
```

### RelationExistenceRule

Eloquent çµŒç”±ã§ DB ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã€å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å ´åˆã«æ¤œçŸ¥ã§ãã¾ã™ã€‚

```
\App\User::query()->has('foo');
\App\Post::query()->has('users.transactions.foo');
```

ä¸‹è¨˜ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```
Relation 'foo' is not found in App\User model.
Relation 'foo' is not found in App\Transaction model.
```

### ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯

- è¿”ã‚Šå€¤ãŒå®Ÿéš›ã®å‡¦ç†ã¨åˆã£ã¦ã„ã‚‹ã‹
- å¼•æ•°ã®å‹ã¨å‘½åã¯ä¸€è‡´ã—ã¦ã„ã‚‹ã‹

ãªã©ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

ä¿®æ­£ä¾‹ï¼‘ã€‚

```
/**
  * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸå•†å“ã‚’å–å¾—ã™ã‚‹ã€‚
  *
  * @return \Illuminate\Database\Eloquent\Relations\HasMany
  */
public function products()
{
    return $this->hasMany(Product::class);
}
```

ä¿®æ­£ä¾‹ï¼’ã€‚

```
/**
  * æŒ‡å®šåˆ—ã‚’ç‰¹å®šæ—¥ã§çµã‚Šè¾¼ã‚€ã€‚
  *
  * @param Illuminate\Database\Eloquent\Builder $builder ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€
  * @param date $date ç‰¹å®šæ—¥
  * @param date $column çµã‚Šè¾¼ã¿ã‚«ãƒ©ãƒ å
  * @return \Illuminate\Database\Eloquent\Builder
  */
private static function filterColumnsBySpecificDate($builder, $date, $column)
{
    return $builder->whereDate($column, $date);
}
```

é©ç”¨ãƒ«ãƒ¼ãƒ«ã¯ Github ã«ã‚ã‚Šã¾ã™ã®ã§ã€å‚ç…§ãã ã•ã„ã€‚

https://github.com/nunomaduro/larastan/blob/master/docs/rules.md

## è§£æã‚’ç„¡è¦–ã™ã‚‹ã¨ã

ã©ã†ã—ã¦ã‚‚è§£æã‚’ç„¡è¦–ã—ãŸã„æ™‚ãŒã‚ã‚‹ã¯ãšã§ã™ã€‚

ãã®æ™‚ã¯ã€baseline ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨è‰¯ã„ã§ã™ã€‚

```
./vendor/bin/phpstan analyse --generate-baseline
```

å®Ÿè¡Œå¾Œã€`phpstan-baseline.neon` ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã€å®Ÿéš›ã«ç„¡è¦–ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼å†…å®¹ãŒè¨˜è¼‰ã•ã‚Œã¾ã™ã€‚

```
parameters:
    ignoreErrors:
        -
            message: "#^Call to an undefined static method Foo\\:\\:sub\\(\\)\\.$#"
            count: 1
            path: index.php
```

## è§£æã®è‡ªå‹•åŒ–

å®Ÿéš›ã« Larastan ã‚’å°å…¥ã—ã¦ã‚‚å„è‡ªãŒãƒã‚§ãƒƒã‚¯ã—ãªã„ã¨æ„å‘³ãŒãªã„ãŸã‚ã€å¼·åˆ¶çš„ã« Github ã¸ commit ã—ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«è‡ªå‹•åŒ–ã—ã¾ã™ã€‚

ã¾ãšã¯ã€.github/workflows/phpstan.yaml ã¨ã—ã¦ä¸‹è¨˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```
name: larastan

on:
  pull_request:
    paths:
      - "**.php"

jobs:
  laravel:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        tools: composer:v2
    - name: Resolve dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader
    - name: Run larastan
      run: ./vendor/bin/phpstan analyse --memory-limit=2G --configuration=phpstan.neon
```

Actions ã§ã¯ã€`shivammathur/setup-php@v2` ã‚’åˆ©ç”¨ã—ã¦ PHP ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚

ãã®å¾Œã¯ã€composer install ã‚’å®Ÿè¡Œã—ã€Larastan å®Ÿè¡Œã™ã‚‹ã¨ã„ã†å˜ç´”ãª CI ã§ã™ã€‚

GitHubActrions ã®ãƒˆãƒªã‚¬ãƒ¼ã¯ pull request ã« php ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œã•ã›ã¾ã™ã€‚

å®Ÿéš›ã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸç®‡æ‰€ã‚‚æŒ‡æ‘˜ã—ã¦ãã‚Œã¾ã™ã€‚

## æ›´ãªã‚‹è‡ªå‹•åŒ–ã®æ¤œè¨

ä¸Šè¨˜ã®é€šã‚Šã€è‡ªå‹•åŒ–ãŒã§ããŸã®ã§ã™ãŒã€Github ã® PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚ŒãŸã„ã€‚

ã¨æ€ã„ã€ `reviewdog` ã®å°å…¥ã‚’æ¤œè¨ã—ã¾ã—ãŸã€‚

### reviewdog ã¨ã¯

reviewdog ã¨ã¯ã€å„ç¨® linter ç­‰ã®å®Ÿè¡Œçµæœã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã§æŒ‡æ‘˜ã—ã¦ãã‚Œã¾ã™ã€‚ è©³ç´°ãªèª¬æ˜ã¯ä½œè€…æ§˜ã®è¨˜äº‹ã‚’å‚ç…§ã™ã‚‹ã®ãŒè‰¯ã„ã§ã™ã€‚

http://haya14busa.com/reviewdog/

reviewdog ã‚’å°å…¥ã—ãŸå ´åˆã® yaml ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

```
name: larastan
on:
  pull_request:
    paths:
      - "**.php"

jobs:
  analyse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          tools: composer:v2
      - name: Resolve dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader
      - name: Run PHPstan
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./vendor/bin/phpstan analyse --error-format=raw --no-progress | reviewdog -reporter=github-pr-review -f=phpstan
```

ã“ã®æ™‚ã«æ³¨æ„ã—ãªã„ã¨ã„ã‘ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

`REVIEWDOG_GITHUB_API_TOKEN` ã«æŒ‡å®šã—ã¦ã„ã‚‹ GITHUB_TOKEN ã¯ Personal Access Tokens ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¨è¨€ã„ã¾ã™ã®ã‚‚ã€reviewdog ã§ã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ›¸ãè¾¼ã¿ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€workflow ã«æ›¸ãè¾¼ã¿æ¨©é™ãŒãªã„ã¨ã§ããªã„ã‹ã‚‰ã§ã™ã€‚

Personal Access Tokens ã‚’ä½œæˆã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚

## ã¾ã¨ã‚

ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚

æœ€ä½é™ã®ã“ã¨ã¯ Larastan ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä»»ã›ã€ãƒ¬ãƒ“ãƒ¥ã‚¢ã¯ä¸»è¦ãªå®Ÿè£…ã«é›†ä¸­ã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

çš†ã•ã‚“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚‚æ˜¯éå°å…¥ã•ã‚Œã¦ã¿ã¦ãã ã•ã„ã€‚
